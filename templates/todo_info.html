{% extends 'base.html' %}
{% block content %}
    <div style="display:flex;">
    <h1>TodoInfo</h1>
    {% if request.user == todo.author or request.user.is_superuser %}
    <div style="text-align: right; margin-left: auto;">
            <a href="{% url 'todo:update' todo.id %}" class="btn btn-warning opacity-50">수정</a>
        <form action="{% url 'todo:delete' todo.id %}" method="POST" style="display:inline">
            {% csrf_token %}
            <input type="button" class="btn btn-danger opacity-50" onclick="btn_delete(event)" value="삭제">
        </form>
    </div>
    {% endif %}
    </div>
    <ul class="list-group list-group-flush">
        <li class="list-group-item">번호 : {{ todo.id }}</li>
        <li class="list-group-item">제목 : {{ todo.title }}</li>
        <li class="list-group-item">설명 : {{ todo.description }}</li>
        <li class="list-group-item">시작일 : {{ todo.start_date }}</li>
        <li class="list-group-item">마감일 : {{ todo.end_date }}</li>
        <li class="list-group-item">완료여부 :
            {% if todo.is_completed %}
            ✅
            {% else %}
            ❌
            {% endif %}
        </li>
        <li class="list-group-item">생성일 : {{ todo.created_at }}</li>
        <li class="list-group-item">수정일 : {{ todo.modified_at }}</li>
    </ul>
    {% if request.user.is_authenticated %}
{#            <form method="post">#}
        <form method="post" action="{% url 'todo:comment-create' todo.pk %}">
            {% csrf_token %}
            {{ comment_form.as_p }}
            <div class="text-end">
                <button class="btn btn-primary opacity-50">댓글작성</button>
            </div>
        </form>
    {% endif %}
    <div class="mb-5" id="comment_wrapper">
{#        Django에서는 ForeignKey(외래 키) 관계가 설정되면, 역참조(Reverse Lookup)를 위한 관련 매니저가 자동으로 생성됩니다.#}
{#        즉, Comment 모델이 Todo 모델을 참조하고 있다면, Django는 자동으로 todo.comment_set이라는 매니저를 제공하여 해당 Todo 객체에 연결된 모든 Comment를 가져올 수 있도록 합니다.#}
{#        {% for comment in todo.comment_set.all %}#}
        {% for comment in object_list %}

            <div class="border-bottom mb-3" id="comment-{{ comment.id }}">
                <div class="d-flex justify-content-between">
                    <div class="w-100">

                        <!-- 댓글 내용 -->
                        <p id="content-{{ comment.id }}">{{ comment.content }}</p>

                        <!-- 수정 입력창: 처음엔 숨겨져 있음 -->
                        <div id="edit-form-{{ comment.id }}" style="display: none;">

                            <form method="post" action="{% url 'todo:comment-update' comment.pk %}">
                                {% csrf_token %}
                                {{ comment_form.as_p }}
                                <div class="text-end">
                                    <button class="btn btn-sm btn-success">저장</button>
                                    <button class="btn btn-sm btn-secondary" onclick="cancelEdit({{ comment.id }})">취소</button>
                                </div>
                            </form>
                        </div>

                        <!-- 작성자 및 시간 -->
                        <p class="text-end mt-2">
                            <small>{{ comment.created_at|date:"Y-m-d H:i" }} | {{ comment.author.username }}</small>
                        </p>
                    </div>

                    <!-- 수정/삭제 버튼 -->
                    {% if request.user == comment.author or request.user.is_superuser %}
                    <div class="ms-2 text-end">
                        <button class="btn btn-warning opacity-50" onclick="editComment({{ comment.id }})">수정</button>
                        <form action="{% url 'todo:comment-delete' comment.pk %}" method="POST" style="display:inline">
                            {% csrf_token %}
                            <input type="button" class="btn btn-danger opacity-50" onclick="btn_delete(event)" value="삭제">
                        </form>
                    </div>
                    {% endif %}
                </div>
            </div>

        {% endfor %}
    </div>

    <div style="text-align: right;">
        <small>by {{ todo.author.username }}</small>
    </div>
    {%  include 'pagination.html' with fragment='comment_wrapper' %}
    <div style="text-align: center; margin: 50px 0;">
        <a class="btn btn-secondary opacity-50" href="{% url 'todo:list' %}">목록</a>
    </div>
{% endblock %}
{% block js %}
    <script>
        function editComment(commentId) {
            document.querySelector('#content-' + commentId).style.display = 'none';
            document.querySelector('#edit-form-' + commentId).style.display = 'block';
        }

        function cancelEdit(commentId) {
            document.querySelector('#edit-form-' + commentId).style.display = 'none';
            document.querySelector('#content-' + commentId).style.display = 'block';
        }
        function btn_delete(e) {
            if(confirm('삭제 하시겠습니까?')){
                // 버튼 기준으로 가장 가까운 form 태그 찾기
                e.target.closest('form').submit();
            }
        }


    </script>
{% endblock %}